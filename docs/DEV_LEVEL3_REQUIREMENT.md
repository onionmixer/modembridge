# DEV_LEVEL3_REQUIREMENT - Level 3 개발 요구사항

## 개요
Level 3는 데이터 동기화 및 파이프라인 관리 계층으로, Level 1(Serial/Modem)과 Level 2(Telnet) 사이의 고성능 데이터 브리지를 제공합니다.

## 핵심 개념

### 1. 이중 파이프라인 구조
Level 3는 두 개의 독립적인 단방향 파이프라인으로 구성됩니다:

#### Pipeline 1: Serial → Telnet
```
Serial Port → Level 1 Output → Level 3 Buffer → Level 2 Input → Telnet Server
```
- 클라이언트에서 서버로 향하는 데이터 경로
- Hayes AT 명령 필터링
- ANSI 제어 코드 처리

#### Pipeline 2: Telnet → Serial
```
Telnet Server → Level 2 Output → Level 3 Buffer → Level 1 Input → Serial Port
```
- 서버에서 클라이언트로 향하는 데이터 경로
- Telnet IAC 명령 처리
- 흐름 제어 적용

### 2. Half-Duplex 동작 원리
**설계 철학**: 한 순간에는 하나의 파이프라인만 활성화

**이유**:
- 단순성: 동시 양방향 처리의 복잡성 제거
- 안정성: 데드락 및 경쟁 조건 방지
- 효율성: 컨텍스트 스위칭 최소화
- 제어: 명확한 데이터 흐름 관리

**전문가 피드백 (원문 보존)**:
> "Half-duplex 방식은 훌륭한 선택입니다. 실시간 시스템에서 복잡한 양방향 동시 처리보다 단순한 교대 처리가 더 안정적이고 디버깅이 쉽습니다."

### 3. 버퍼 아키텍처

#### 3.1 메인 버퍼 (4096 바이트)
- 각 파이프라인별 독립 버퍼
- 순환 버퍼 구조
- Thread-safe 접근

#### 3.2 보조 버퍼
- 멀티바이트 문자 처리용
- 부분 명령 누적용
- 오버플로우 대응

#### 3.3 워터마크 시스템
```
CRITICAL (95%) - 긴급 정지
HIGH     (80%) - 백프레셔 적용
LOW      (20%) - 백프레셔 해제
EMPTY    (5%)  - 버퍼 거의 비어있음
```

### 4. 상태 기계 요구사항

#### 4.1 필수 상태 (10개)
```c
typedef enum {
    L3_STATE_UNINITIALIZED,  // 초기화 전
    L3_STATE_INITIALIZING,   // 초기화 중
    L3_STATE_READY,          // 준비 완료
    L3_STATE_CONNECTING,     // 연결 시도
    L3_STATE_NEGOTIATING,    // 프로토콜 협상
    L3_STATE_DATA_TRANSFER,  // 데이터 전송
    L3_STATE_FLUSHING,       // 버퍼 비우기
    L3_STATE_SHUTTING_DOWN,  // 종료 중
    L3_STATE_TERMINATED,     // 종료됨
    L3_STATE_ERROR           // 에러 상태
} level3_state_t;
```

#### 4.2 상태 전이 규칙
- 모든 전이는 원자적 연산
- 불가능한 전이는 에러 처리
- 상태 변경 시 로깅 필수

### 5. 스케줄링 요구사항

#### 5.1 Quantum 기반 공정 스케줄링
- **Quantum 크기**: 50ms (조정 가능)
- **정책**: Round-robin
- **우선순위**: Pipeline 1 = Pipeline 2

#### 5.2 Anti-Starvation 메커니즘
- **임계값**: 500ms
- **동작**: 500ms 이상 대기 시 강제 실행
- **보장**: 최악의 경우에도 1초 내 처리

#### 5.3 적응형 스케줄링
- 1200 bps: 더 짧은 quantum (10ms)
- 115200 bps: 표준 quantum (50ms)
- 유휴 상태: sleep 모드

### 6. 필터링 요구사항

#### 6.1 Hayes AT 명령 필터링 (Pipeline 1)
- Command 모드: AT 명령 차단
- Online 모드: 데이터 통과
- Escape 시퀀스: +++ 감지

#### 6.2 Telnet 제어 코드 필터링 (Pipeline 2)
- IAC 명령: Level 2에서 처리
- 서브협상: 투명 전달 금지
- 바이너리 모드: 예외 처리

### 7. 성능 요구사항

#### 7.1 지연시간
- **평균**: < 100ms
- **최대**: < 500ms
- **Jitter**: < 50ms

#### 7.2 처리량
- **최소**: 300 bps
- **표준**: 57,600 bps
- **최대**: 115,200 bps

#### 7.3 버퍼 오버플로우
- **목표**: < 1%
- **복구**: 자동 재시도
- **로깅**: 모든 오버플로우 기록

### 8. 안정성 요구사항

#### 8.1 에러 처리
- 모든 에러는 복구 가능해야 함
- 치명적 에러 시 graceful shutdown
- 에러 상태에서 재초기화 가능

#### 8.2 데이터 무결성
- 멀티바이트 문자 경계 보존
- 순서 보장 (FIFO)
- 중복/손실 방지

#### 8.3 동기화
- Race condition 방지
- Deadlock 방지
- Livelock 방지

### 9. 모니터링 요구사항

#### 9.1 실시간 메트릭
- 파이프라인별 처리량
- 버퍼 사용률
- 지연시간 통계
- 에러율

#### 9.2 디버깅 지원
- 상태 덤프
- 버퍼 내용 확인
- 플로우 추적
- 성능 프로파일링

### 10. 구성 요구사항

#### 10.1 조정 가능 파라미터
- Quantum 크기
- 버퍼 크기
- 워터마크 레벨
- 타임아웃 값

#### 10.2 프리셋 구성
- 저속 모뎀 (300-2400 bps)
- 표준 모뎀 (9600-57600 bps)
- 고속 모뎀 (115200 bps)
- 채팅 서버 최적화
- 파일 전송 최적화

## 검증 기준

### 기능 검증
- [ ] 10개 상태 모두 도달 가능
- [ ] 양방향 데이터 전송 동작
- [ ] 멀티바이트 문자 무결성
- [ ] Hayes/Telnet 필터링 정확성

### 성능 검증
- [ ] 평균 지연시간 < 100ms
- [ ] 버퍼 오버플로우 < 1%
- [ ] CPU 사용률 < 10%
- [ ] 메모리 누수 없음

### 안정성 검증
- [ ] 24시간 연속 운영
- [ ] 100만 바이트 전송
- [ ] 1000회 연결/해제
- [ ] 에러 복구 100%

## 우선순위

1. **필수**: 기본 파이프라인 동작
2. **필수**: 상태 기계 구현
3. **필수**: 버퍼 관리
4. **권장**: 스케줄링 최적화
5. **선택**: 고급 모니터링

## 제약사항

### 기술적 제약
- 단일 스레드 이벤트 루프
- 최대 버퍼 크기 제한
- POSIX 호환성 필요

### 운영 제약
- Root 권한 불필요
- 시그널 안전성
- 리소스 제한 준수

## 참고사항

### 원문 요구사항 (한국어 보존)
```
"Level 3은 반이중 방식으로 한 순간에 하나의 파이프라인만 활성화됩니다.
이는 복잡성을 줄이고 안정성을 높이기 위한 설계 결정입니다."

"버퍼 오버플로우는 1% 미만을 목표로 하되, 저속 연결(1200bps)에서는
예외적으로 5%까지 허용합니다."

"상태 기계는 모든 상태 전이를 로깅하여 디버깅을 용이하게 해야 합니다."
```

---
*최초 작성: 2025-10-15*
*최종 검토: 2025-10-23*